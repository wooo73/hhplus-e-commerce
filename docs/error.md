# 장애 대응 문서

### 장애 상황

> 17시에 오픈되는 선착순 쿠폰 발급 트래픽이 급증하게 되면서 서버 / DB 과부하로 인한 쿠폰 발급 기능 다운.

### 장애 확인

---

- 슬랙 알람을 통해 500번대 응답 오류 지속 발생 확인.
- 선임자가 관련 부서에게 해당 장애에 대한 상황 전파.
- 책임자들은 장애 해결을 위한 작업 진행.

### 장애 대응

---

- Grafana & Prometheus를 통해 모니터링 지표 확인.

    - 한 번에 몰린 트래픽으로 인한 서버 OOM 발생, 비관적락으로 인한 처리량 지연, 데이터베이스 과부하 확인.

**핫픽스**

- 모니터링한 트래픽에 기반하여 쿠폰 발급 API에 Rate Limit을 적용해 감당 가능한 트래픽까지만 처리하도록 처리.

- 비관적락에서 Redis를 이용한 분산락 적용.

- QA 테스트를 통해 검증 후 배포.

- 실시간 모니터링.

## 장애 후속 조치

---

- 모니터링한 트래픽 기반 EC2 오토 스케일링을 적용하여 특정 트래픽이 몰리면 자동으로 서버를 증설할 수 있도록 세팅.

- 로드밸런서(ELB) 구축으로 서버 부하 분산 적용.

    - Health Check를 통한 서버 상태 모니터링 시스템 추가 구축.

- DB Replication을 통해 여러대 DB 구축으로 DB 서버의 부하 분산 고려.

    - Connection Pool, Transaction Time Out 등 부하 테스트를 통해 세팅 재설정.
    - 쿼리, 인덱스 점검.
    - Pub-Sub 구조의 레디스 분산락 적용 고려.

- 쿠폰 로직 개선.

    - 비동기 처리 방식 도입 고려. (메시지 큐 활용)

- 실제 환경과 유사한 부하 테스트 환경을 구축해 장애 방지 체계 도입.

- 지정한 트래픽 달성시 메신저 알람 및 모니터링 지표 강화 고려.

- 필요시 서비스 아키텍처 점검.

## 리뷰

---

- 발생한 장애에 대한 문서를 기반으로 현재 프로세스 체계 개선.

- 개인 회고.
